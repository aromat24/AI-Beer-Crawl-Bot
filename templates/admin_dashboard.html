<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Beer Crawl - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .stat-label {
            font-weight: 500;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
        }

        .success {
            color: #27ae60;
            background: #f0f9f0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }

        .actions-card {
            grid-column: span 2;
        }

        @media (max-width: 768px) {
            .actions-card {
                grid-column: span 1;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            background: #5a6fd8;
        }

        /* Bot Controls Styles */
        .bot-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .control-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .control-row label {
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: 500;
            color: #495057;
        }

        .control-row input[type="number"] {
            margin-left: 8px;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            width: 80px;
            font-size: 13px;
        }

        .control-row input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .control-actions {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .control-actions .btn {
            margin: 0 10px;
        }

        .btn-primary {
            background: #28a745;
            border-color: #28a745;
        }

        .btn-primary:hover {
            background: #218838;
            border-color: #1e7e34;
        }

        .btn-secondary {
            background: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #545b62;
        }

        /* Bot Response Editor Styles */
        .response-editor {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
        }

        .response-item {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .response-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .response-label {
            font-weight: 500;
            color: #495057;
            padding-top: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .response-textarea {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.4;
        }

        .response-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Celery Status Indicators */
        .celery-worker {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            font-size: 11px;
        }

        .worker-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
            font-size: 10px;
        }

        .worker-status.online {
            background: #d4edda;
            color: #155724;
        }

        .worker-status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç∫ AI Beer Crawl Admin Dashboard</h1>
            <p>Monitor and manage your WhatsApp bot system</p>
        </div>

        <div class="dashboard-grid">
            <!-- System Stats -->
            <div class="card">
                <h3>üìä System Statistics</h3>
                <div id="system-stats" class="loading">Loading...</div>
            </div>

            <!-- User Stats -->
            <div class="card">
                <h3>üë• User Statistics</h3>
                <div id="user-stats" class="loading">Loading...</div>
            </div>

            <!-- Beer Crawl Stats -->
            <div class="card">
                <h3>üçª Beer Crawl Statistics</h3>
                <div id="crawl-stats" class="loading">Loading...</div>
            </div>

            <!-- Redis Stats -->
            <div class="card">
                <h3>üî¥ Redis Statistics</h3>
                <div id="redis-stats" class="loading">Loading...</div>
            </div>

            <!-- Celery/Flower Monitoring -->
            <div class="card">
                <h3>‚öôÔ∏è Celery Monitoring</h3>
                <div id="celery-stats" class="loading">Loading...</div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="startFlower()">üå∏ Start Flower</button>
                    <button class="btn" onclick="openFlower()">üìä Open Flower UI</button>
                    <button class="btn" onclick="refreshCeleryStats()">üîÑ Refresh</button>
                </div>
                <div id="flower-result" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- Bot Behavior Controls -->
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="card" style="grid-column: 1 / -1;">
                <h3>ü§ñ Bot Behavior Controls</h3>
                <div class="bot-controls">
                    <!-- Group Settings -->
                    <div class="control-section">
                        <h4>üë• Group Management</h4>
                        <div class="control-row">
                            <label>Min Group Size:</label>
                            <input type="number" id="min-group-size" min="2" max="10" value="2">
                            <label>Max Group Size:</label>
                            <input type="number" id="max-group-size" min="3" max="20" value="5">
                            <label>Group Creation Threshold:</label>
                            <input type="number" id="group-threshold" min="1" max="10" value="3">
                        </div>
                        <div class="control-row">
                            <label>Group Deletion Timer (hours):</label>
                            <input type="number" id="group-deletion-timer" min="1" max="168" value="24">
                            <label>Session Duration (hours):</label>
                            <input type="number" id="session-duration" min="1" max="12" value="4">
                        </div>
                    </div>

                    <!-- Response Settings -->
                    <div class="control-section">
                        <h4>üí¨ Response Settings</h4>
                        <div class="control-row">
                            <label>Message Cooldown (seconds):</label>
                            <input type="number" id="message-cooldown" min="5" max="300" value="30">
                            <label>User Cooldown (seconds):</label>
                            <input type="number" id="user-cooldown" min="5" max="60" value="10">
                        </div>
                        <div class="control-row">
                            <label>Rate Limit Window (seconds):</label>
                            <input type="number" id="rate-limit-window" min="60" max="3600" value="300">
                            <label>Max Messages per Window:</label>
                            <input type="number" id="rate-limit-max" min="1" max="50" value="5">
                        </div>
                    </div>

                    <!-- Timing Controls -->
                    <div class="control-section">
                        <h4>‚è∞ Timing Controls</h4>
                        <div class="control-row">
                            <label>Bar Progression Time (minutes):</label>
                            <input type="number" id="bar-progression-time" min="15" max="180" value="60">
                            <label>Wait Time Between Bars (minutes):</label>
                            <input type="number" id="wait-between-bars" min="5" max="60" value="15">
                        </div>
                        <div class="control-row">
                            <label>Join Deadline (minutes):</label>
                            <input type="number" id="join-deadline" min="5" max="120" value="30">
                            <label>Auto-start Threshold:</label>
                            <input type="number" id="auto-start-threshold" min="2" max="10" value="4">
                        </div>
                    </div>

                    <!-- Bot Behavior -->
                    <div class="control-section">
                        <h4>üéØ Bot Behavior</h4>
                        <div class="control-row">
                            <label>
                                <input type="checkbox" id="auto-group-creation" checked>
                                Auto Group Creation
                            </label>
                            <label>
                                <input type="checkbox" id="smart-matching" checked>
                                Smart Location Matching
                            </label>
                            <label>
                                <input type="checkbox" id="auto-progression" checked>
                                Auto Bar Progression
                            </label>
                        </div>
                        <div class="control-row">
                            <label>
                                <input type="checkbox" id="welcome-messages" checked>
                                Send Welcome Messages
                            </label>
                            <label>
                                <input type="checkbox" id="reminder-messages" checked>
                                Send Reminder Messages
                            </label>
                            <label>
                                <input type="checkbox" id="debug-mode">
                                Debug Mode
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="control-actions">
                        <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
                        <button class="btn btn-secondary" onclick="loadSettings()">üîÑ Reload Settings</button>
                        <button class="btn btn-warning" onclick="resetToDefaults()">‚ö†Ô∏è Reset to Defaults</button>
                    </div>

                    <div id="settings-result" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>

        <!-- Bot Response Management -->
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="card" style="grid-column: 1 / -1;">
                <h3>üí¨ Bot Response Management</h3>
                <div class="bot-controls">
                    <div class="control-section">
                        <h4>üìù Edit Bot Responses</h4>
                        <div id="bot-responses-container" class="loading">Loading responses...</div>
                        <div class="control-actions">
                            <button class="btn btn-primary" onclick="saveBotResponses()">üíæ Save Responses</button>
                            <button class="btn btn-secondary" onclick="loadBotResponses()">üîÑ Reload</button>
                            <button class="btn btn-warning" onclick="resetBotResponses()">‚ö†Ô∏è Reset to Defaults</button>
                        </div>
                        <div id="bot-responses-result" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid" style="margin-top: 20px;">
            <!-- Recent Users -->
            <div class="card">
                <h3>üë§ Recent Users</h3>
                <div id="recent-users" class="loading">Loading...</div>
            </div>

            <!-- Recent Beer Crawls -->
            <div class="card">
                <h3>üç∫ Recent Beer Crawls</h3>
                <div id="recent-crawls" class="loading">Loading...</div>
            </div>

            <!-- Redis Data -->
            <div class="card">
                <h3>üíæ Redis Data</h3>
                <div id="redis-data" class="loading">Loading...</div>
            </div>

            <!-- System Actions -->
            <div class="card actions-card">
                <h3>‚öôÔ∏è System Actions</h3>
                <div>
                    <button class="btn" onclick="refreshAllData()">üîÑ Refresh All Data</button>
                    <button class="btn btn-warning" onclick="clearDeduplication()">üßπ Clear Deduplication</button>
                    <button class="btn btn-warning" onclick="clearRedis()">üóëÔ∏è Clear Redis/Celery</button>
                    <button class="btn btn-danger" onclick="clearDatabase()">‚ö†Ô∏è Clear Database</button>
                </div>
                <div id="action-result" style="margin-top: 15px;"></div>
            </div>

            <!-- System Logs -->
            <div class="card actions-card">
                <h3>üìã Recent Logs</h3>
                <div id="system-logs" class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshAllData()" title="Refresh All Data">üîÑ</button>

    <script>
        let refreshInterval;

        // Auto-refresh every 30 seconds
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshAllData, 30000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        async function fetchData(endpoint) {
            try {
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                return { error: error.message };
            }
        }

        async function loadSystemStats() {
            const data = await fetchData('/api/stats');
            const container = document.getElementById('system-stats');
            
            if (data.error) {
                container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">Total Users:</span>
                    <span class="stat-value">${data.total_users || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Onboarded Users:</span>
                    <span class="stat-value">${data.onboarded_users || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Crawls:</span>
                    <span class="stat-value">${data.active_crawls || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">New Users (24h):</span>
                    <span class="stat-value">${data.new_users_24h || 0}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Redis Memory:</span>
                    <span class="stat-value">${data.redis_used_memory || 'N/A'}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dedup Entries:</span>
                    <span class="stat-value">${data.dedup_entries || 0}</span>
                </div>
            `;
        }

        async function loadUsers() {
            const data = await fetchData('/api/users');
            const container = document.getElementById('recent-users');
            
            if (data.error) {
                container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<p>No users found</p>';
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Number</th>
                            <th>Status</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.slice(0, 10).forEach(user => {
                tableHTML += `
                    <tr>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.whatsapp_number}</td>
                        <td>${user.onboarding_completed ? '‚úÖ Complete' : '‚è≥ Pending'}</td>
                        <td>${user.location || 'N/A'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        async function loadCrawls() {
            const data = await fetchData('/api/crawls');
            const container = document.getElementById('recent-crawls');
            
            if (data.error) {
                container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<p>No beer crawls found</p>';
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Participants</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.slice(0, 10).forEach(crawl => {
                tableHTML += `
                    <tr>
                        <td>${crawl.name || 'N/A'}</td>
                        <td>${crawl.status}</td>
                        <td>${crawl.current_participants}/${crawl.max_participants}</td>
                        <td>${crawl.location || 'N/A'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        async function loadRedisData() {
            const data = await fetchData('/api/redis');
            const container = document.getElementById('redis-data');
            
            if (data.error) {
                container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            let html = '<h4>Main Redis DB (Celery)</h4>';
            if (data.main_db && data.main_db.error) {
                html += `<div class="error">${data.main_db.error}</div>`;
            } else if (data.main_db) {
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Total Keys:</span>
                        <span class="stat-value">${data.main_db.total_keys}</span>
                    </div>
                `;
            }

            html += '<h4>Deduplication DB</h4>';
            if (data.dedup_db && data.dedup_db.error) {
                html += `<div class="error">${data.dedup_db.error}</div>`;
            } else if (data.dedup_db) {
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Total Keys:</span>
                        <span class="stat-value">${data.dedup_db.total_keys}</span>
                    </div>
                `;
                
                if (data.dedup_db.entries && Object.keys(data.dedup_db.entries).length > 0) {
                    html += '<h5>Recent Entries:</h5>';
                    Object.entries(data.dedup_db.entries).forEach(([key, value]) => {
                        html += `
                            <div class="stat-item" style="font-size: 11px;">
                                <span>${key}</span>
                                <span>TTL: ${value.ttl}</span>
                            </div>
                        `;
                    });
                }
            }

            container.innerHTML = html;
        }

        async function loadLogs() {
            const data = await fetchData('/api/logs');
            const container = document.getElementById('system-logs');
            
            if (data.error) {
                container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            if (data.logs && data.logs.length > 0) {
                container.innerHTML = `<div class="log-container">${data.logs.join('')}</div>`;
            } else {
                container.innerHTML = '<p>No logs found</p>';
            }
        }

        async function clearDeduplication() {
            if (!confirm('Are you sure you want to clear all deduplication data?')) {
                return;
            }

            const resultDiv = document.getElementById('action-result');
            resultDiv.innerHTML = '<div class="loading">Clearing deduplication data...</div>';

            try {
                const response = await fetch('/api/clear_dedup', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">${data.message}</div>`;
                    setTimeout(refreshAllData, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function clearRedis() {
            if (!confirm('Are you sure you want to clear Redis/Celery queues? This will stop all background tasks!')) {
                return;
            }

            const resultDiv = document.getElementById('action-result');
            resultDiv.innerHTML = '<div class="loading">Clearing Redis data...</div>';

            try {
                const response = await fetch('/api/clear_redis', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">${data.message}</div>`;
                    setTimeout(refreshAllData, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function clearDatabase() {
            const confirmText = 'CLEAR ALL DATA';
            const userInput = prompt(`‚ö†Ô∏è DANGER: This will permanently delete ALL users and beer crawls!\n\nType "${confirmText}" to confirm:`);
            
            if (userInput !== confirmText) {
                return;
            }

            const resultDiv = document.getElementById('action-result');
            resultDiv.innerHTML = '<div class="loading">Clearing database...</div>';

            try {
                const response = await fetch('/api/clear_database', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">${data.message}</div>`;
                    setTimeout(refreshAllData, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Celery/Flower monitoring functions
        async function loadCeleryStats() {
            const data = await fetchData('/api/celery/stats');
            const container = document.getElementById('celery-stats');
            
            if (data.error) {
                container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                return;
            }

            let html = '';
            
            if (data.flower_available) {
                html += '<div class="success">üå∏ Flower is running</div>';
                html += `
                    <div class="stat-item">
                        <span class="stat-label">Workers:</span>
                        <span class="stat-value">${data.workers.length}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Tasks:</span>
                        <span class="stat-value">${data.tasks.active}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Processed:</span>
                        <span class="stat-value">${data.tasks.processed}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Failed:</span>
                        <span class="stat-value">${data.tasks.failed}</span>
                    </div>
                `;
                
                if (data.workers.length > 0) {
                    html += '<h5>Workers:</h5>';
                    data.workers.forEach(worker => {
                        html += `
                            <div class="stat-item" style="font-size: 11px;">
                                <span>${worker.name.split('@')[0]}</span>
                                <span style="color: ${worker.status === 'online' ? '#27ae60' : '#e74c3c'}">
                                    ${worker.status} (${worker.active_tasks} active)
                                </span>
                            </div>
                        `;
                    });
                }
            } else {
                html += '<div class="error">‚ùå Flower not available</div>';
                if (data.redis_queues !== undefined) {
                    html += `
                        <div class="stat-item">
                            <span class="stat-label">Redis Queue Keys:</span>
                            <span class="stat-value">${data.redis_queues}</span>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        async function startFlower() {
            const resultDiv = document.getElementById('flower-result');
            resultDiv.innerHTML = '<div class="loading">Starting Flower...</div>';

            try {
                const response = await fetch('/api/celery/flower/start', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">${data.message}</div>`;
                    setTimeout(loadCeleryStats, 2000);
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function openFlower() {
            window.open('http://localhost:5555', '_blank');
        }

        function refreshCeleryStats() {
            loadCeleryStats();
        }

        // Bot Response Management functions
        let currentBotResponses = {};

        async function loadBotResponses() {
            const container = document.getElementById('bot-responses-container');
            container.innerHTML = '<div class="loading">Loading bot responses...</div>';

            try {
                const data = await fetchData('/api/bot-responses');
                
                if (data.error) {
                    container.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }

                currentBotResponses = data.responses;
                renderBotResponsesEditor(data.responses);
            } catch (error) {
                container.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function renderBotResponsesEditor(responses) {
            const container = document.getElementById('bot-responses-container');
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            Object.entries(responses).forEach(([key, value]) => {
                html += `
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 10px; align-items: start;">
                        <label style="font-weight: 500; color: #495057; padding-top: 8px;">
                            ${key.replace(/_/g, ' ').toUpperCase()}:
                        </label>
                        <textarea 
                            id="response-${key}" 
                            style="padding: 8px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical; min-height: 60px; font-family: inherit;"
                            placeholder="Enter ${key} response..."
                        >${value}</textarea>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function saveBotResponses() {
            const resultDiv = document.getElementById('bot-responses-result');
            resultDiv.innerHTML = '<div class="loading">Saving bot responses...</div>';

            try {
                const updatedResponses = {};
                
                Object.keys(currentBotResponses).forEach(key => {
                    const textarea = document.getElementById(`response-${key}`);
                    if (textarea) {
                        updatedResponses[key] = textarea.value;
                    }
                });

                const response = await fetch('/api/bot-responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({responses: updatedResponses})
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ ${data.message}</div>`;
                    currentBotResponses = updatedResponses;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function resetBotResponses() {
            if (!confirm('Are you sure you want to reset all bot responses to defaults? This will overwrite your current responses.')) {
                return;
            }

            const resultDiv = document.getElementById('bot-responses-result');
            resultDiv.innerHTML = '<div class="loading">Resetting bot responses...</div>';

            try {
                const response = await fetch('/api/bot-responses/reset', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ ${data.message}</div>`;
                    setTimeout(loadBotResponses, 1000);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function refreshAllData() {
            loadSystemStats();
            loadUsers();
            loadCrawls();
            loadRedisData();
            loadCeleryStats(); // Add Celery stats to refresh
            loadBotResponses(); // Add bot responses to refresh
            loadLogs();
            loadSettings(); // Load bot settings too
        }

        // Bot Control Functions
        async function saveSettings() {
            const resultDiv = document.getElementById('settings-result');
            resultDiv.innerHTML = '<div class="loading">Saving settings...</div>';

            const settings = {
                min_group_size: parseInt(document.getElementById('min-group-size').value),
                max_group_size: parseInt(document.getElementById('max-group-size').value),
                group_threshold: parseInt(document.getElementById('group-threshold').value),
                group_deletion_timer: parseInt(document.getElementById('group-deletion-timer').value),
                session_duration: parseInt(document.getElementById('session-duration').value),
                message_cooldown: parseInt(document.getElementById('message-cooldown').value),
                user_cooldown: parseInt(document.getElementById('user-cooldown').value),
                rate_limit_window: parseInt(document.getElementById('rate-limit-window').value),
                rate_limit_max: parseInt(document.getElementById('rate-limit-max').value),
                bar_progression_time: parseInt(document.getElementById('bar-progression-time').value),
                wait_between_bars: parseInt(document.getElementById('wait-between-bars').value),
                join_deadline: parseInt(document.getElementById('join-deadline').value),
                auto_start_threshold: parseInt(document.getElementById('auto-start-threshold').value),
                auto_group_creation: document.getElementById('auto-group-creation').checked,
                smart_matching: document.getElementById('smart-matching').checked,
                auto_progression: document.getElementById('auto-progression').checked,
                welcome_messages: document.getElementById('welcome-messages').checked,
                reminder_messages: document.getElementById('reminder-messages').checked,
                debug_mode: document.getElementById('debug-mode').checked
            };

            try {
                const response = await fetch('/api/bot-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Settings saved successfully!</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/bot-settings');
                const settings = await response.json();

                if (response.ok) {
                    // Update form fields with current settings
                    document.getElementById('min-group-size').value = settings.min_group_size || 2;
                    document.getElementById('max-group-size').value = settings.max_group_size || 5;
                    document.getElementById('group-threshold').value = settings.group_threshold || 3;
                    document.getElementById('group-deletion-timer').value = settings.group_deletion_timer || 24;
                    document.getElementById('session-duration').value = settings.session_duration || 4;
                    document.getElementById('message-cooldown').value = settings.message_cooldown || 30;
                    document.getElementById('user-cooldown').value = settings.user_cooldown || 10;
                    document.getElementById('rate-limit-window').value = settings.rate_limit_window || 300;
                    document.getElementById('rate-limit-max').value = settings.rate_limit_max || 5;
                    document.getElementById('bar-progression-time').value = settings.bar_progression_time || 60;
                    document.getElementById('wait-between-bars').value = settings.wait_between_bars || 15;
                    document.getElementById('join-deadline').value = settings.join_deadline || 30;
                    document.getElementById('auto-start-threshold').value = settings.auto_start_threshold || 4;
                    document.getElementById('auto-group-creation').checked = settings.auto_group_creation !== false;
                    document.getElementById('smart-matching').checked = settings.smart_matching !== false;
                    document.getElementById('auto-progression').checked = settings.auto_progression !== false;
                    document.getElementById('welcome-messages').checked = settings.welcome_messages !== false;
                    document.getElementById('reminder-messages').checked = settings.reminder_messages !== false;
                    document.getElementById('debug-mode').checked = settings.debug_mode === true;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                // Set default values
                document.getElementById('min-group-size').value = 2;
                document.getElementById('max-group-size').value = 5;
                document.getElementById('group-threshold').value = 3;
                document.getElementById('group-deletion-timer').value = 24;
                document.getElementById('session-duration').value = 4;
                document.getElementById('message-cooldown').value = 30;
                document.getElementById('user-cooldown').value = 10;
                document.getElementById('rate-limit-window').value = 300;
                document.getElementById('rate-limit-max').value = 5;
                document.getElementById('bar-progression-time').value = 60;
                document.getElementById('wait-between-bars').value = 15;
                document.getElementById('join-deadline').value = 30;
                document.getElementById('auto-start-threshold').value = 4;
                document.getElementById('auto-group-creation').checked = true;
                document.getElementById('smart-matching').checked = true;
                document.getElementById('auto-progression').checked = true;
                document.getElementById('welcome-messages').checked = true;
                document.getElementById('reminder-messages').checked = true;
                document.getElementById('debug-mode').checked = false;

                document.getElementById('settings-result').innerHTML = 
                    '<div class="success">‚úÖ Settings reset to defaults. Click "Save Settings" to apply.</div>';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshAllData();
            startAutoRefresh();
        });

        // Stop auto-refresh when page is not visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>
